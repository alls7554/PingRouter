<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">

  <link rel='stylesheet' href='/stylesheets/style.css' />
  <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css' rel='stylesheet' integrity='sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6' crossorigin='anonymous'>
  <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js'></script>

  <title><%= title %></title>
</head>
<body>
  <div class="container-md col-4">
    <h1 class="mb-5"><%= title %></h1>

    <form>
      <div class="form-floating mb-3">
        <input class="form-control" id="floatingInput" placeholder="ID" minlength="2">
        <label for="floatingInput">ID</label>
        <div id="id_check"></div>
      </div>
      
      <div id="pwd">
        <div class="pwd form-floating mb-3">
          <input type="password" class="form-control" id="floatingPassword" placeholder="Password" autocomplete="off" minlength="6">
          <label for="floatingPassword">Password</label>
        </div>
        <div class="pwd form-floating mb-3">
          <input type="password" class="form-control" id="confirmPWD" placeholder="Password" autocomplete="off">
          <label for="floatingPassword">Confirm Password</label>
        </div>
        <div id="pwd_check"></div>
      </div>

      <div class="row">
        <div class="offset-md-8 col-4">
          <button type="button" class="btn btn-primary" id="sign_up">Sign up</button>
        </div>
      </div>
    </form>
  </div>
</body>
<script>

  let spaceExp = new RegExp(/\s/g);
  let id_check = false, pwd_check = false;

  // ID_CHECK when ID input focusout
  $('#floatingInput').on('focusout', () => {
    let id = $('#floatingInput').val();
    $('#id_check').removeAttr('class');

    if(id == '' || spaceExp.exec(id) != null) {
      $('#id_check').text('')
      return;
    } else{
      $.ajax({
      type: 'POST',
      url: `/register/check/${id}`,
      data: {},
      dataType: 'json',
      success: (data) => {
        if(data.available === 'YES'){
          id_check = true;
          $('#id_check').addClass('text-success');
          $('#id_check').text('Available ID');
        } else if (data.available === 'NO'){
          id_check = false;
          $('#id_check').addClass('text-danger');
          $('#id_check').text('Input Other ID');
        }
      }
    });
    }
  });

  // 비밀번호 확인
  $('#pwd').on('propertychange change paste input', '.pwd', () => {
    let pwd = $('#floatingPassword').val();
    let confirmpwd = $('#confirmPWD').val();

    $('#pwd_check').removeAttr('class');

    if((pwd === '' || spaceExp.exec(pwd) != null) && (confirmpwd === '' || spaceExp.exec(confirmpwd) != null)){
      $('#pwd_check').text('');
      return;
    }

    if(1 <= pwd.length && pwd.length < 6) {
      $('#pwd_check').addClass('text-danger');
      $('#pwd_check').text('Invaild password')
    } else {
      if(pwd === confirmpwd) {
        pwd_check = true;
        $('#pwd_check').addClass('text-success');
        $('#pwd_check').text('correct password')
      } else {
        pwd_check = false;
        $('#pwd_check').addClass('text-danger');
        $('#pwd_check').text('Incorrect password')
      }
    }
  });

  // 회원가입
  $('#sign_up').on('click', () => {
    let id = $('#floatingInput').val();

    if(id == '' || spaceExp.exec(id) != null){
      $('#id_check').addClass('text-danger');
      $('#id_check').text('Input ID');
      return;
    } else if (id_check && pwd_check) {
      let pwd = $('#floatingPassword').val();
      $.ajax({
        type: 'POST',
        url: `/register/regist`,
        data: {id, pwd},
        dataType: 'json',
        success: (data) => {
          if(data.available === 'NO') {
            alert('Invalid Input value');
          }
          else {
            alert('회원가입 완료!');
            location.href = '/'
          }
        }
      });
    }
  });
</script>
</html>